<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“ä¿¡å·¥å‹™ç³»çµ± - è€é—†å„€è¡¨æ¿</title>

    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">

     <!-- vConsole for mobile debugging -->
    <script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
    <script>
        // åˆå§‹åŒ– vConsole (æ‰‹æ©Ÿèª¿è©¦å·¥å…·)
        if (typeof VConsole !== 'undefined') {
            var vConsole = new VConsole();
            console.log('ğŸ”§ vConsole å·²å•Ÿç”¨ - é»æ“Šå³ä¸‹è§’ç¶ è‰²æŒ‰éˆ•æŸ¥çœ‹èª¿è©¦è³‡è¨Š');
        }
    </script>
    
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/components.css">

    <script>
        // LIFF åˆå§‹åŒ–é‚è¼¯
        function initializeLIFF() {
            if (typeof liff !== 'undefined') {
                liff.init({
                    liffId: 'YOUR_LIFF_ID' // éœ€è¦å¯¦éš›çš„ LIFF ID
                }).then(() => {
                    console.log('LIFF initialized for Boss Dashboard');
                    // å¯ä»¥åœ¨é€™è£¡æ·»åŠ è€é—†ç‰¹å®šçš„ LIFF åŠŸèƒ½
                }).catch((err) => {
                    console.error('LIFF initialization failed', err);
                });
            }
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ– LIFF
            initializeLIFF();
        });
    </script>
</head>
<body>
    <div class="mobile-container">

        <!-- è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
        <div id="loadingIndicator" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="overlay" id="overlay"></div>
        <!-- å·¥åœ°åˆ—è¡¨é é¢ -->
        <div id="pageSiteList" class="page active">
            <header class="page-header">
                <h1 class="header-title">æˆ‘çš„å·¥åœ°</h1>
            </header>
            <main class="content-area">
                <div class="filter-controls">
                    <select id="filterCriteria" name="filterCriteria">
                        <option value="progress_delay">é€²åº¦é¡¯è‘—è½å¾Œ</option>
                        <option value="cost_overrun">æˆæœ¬è¶…æ”¯é¢¨éšª</option>
                        <option value="expiry_near">åˆç´„å³å°‡åˆ°æœŸ</option>
                    </select>
                    <select id="sortOrder" name="sortOrder">
                        <option value="desc">å•é¡Œæœ€åš´é‡å„ªå…ˆ</option>
                        <option value="asc">è¡¨ç¾æœ€ä½³å„ªå…ˆ</option>
                    </select>
                </div>
                <div id="siteListContainer"></div>
            </main>
        </div>

        <!-- å·¥åœ°å„€è¡¨æ¿é é¢ -->
        <div id="pageSiteDashboard" class="page">
            <header class="page-header">
                <button class="back-button"><i class="fas fa-arrow-left"></i></button>
                <h1 id="dashboardTitle" class="header-title">å·¥åœ°å„€è¡¨æ¿</h1>
            </header>
            <main class="content-area">
                <div class="space-y-4">
                    <!-- ã€ä¿®æ­£å•é¡Œä¸€ã€‘2x2 é‡é»æ•¸æ“šåœ–å¡ -->
                    <section class="top-metrics-grid">
                        <div class="metric-info-card metric-card-1">
                            <div class="label">è·ä¸Šæ¬¡è«‹æ¬¾</div>
                            <div class="value">25 <span class="sub-value">å¤©</span></div>
                        </div>
                        <div class="metric-info-card metric-card-2" id="unpaidMetricsCardTrigger">
                            <div class="label">å·²è«‹æ¬¾ / æœªè«‹æ¬¾</div>
                            <div class="value">1,000<span class="sub-value">è¬</span> / 350<span class="sub-value">è¬</span></div>
                        </div>
                        <div class="metric-info-card metric-card-3">
                            <div class="label">ç›®å‰æˆæœ¬ç¸½é¡</div>
                            <div class="value">1,280<span class="sub-value">è¬</span></div>
                        </div>
                        <div class="metric-info-card metric-card-4">
                            <div class="label">åˆç´„å‰©é¤˜</div>
                            <div class="value">120 <span class="sub-value">å¤©</span></div>
                        </div>
                    </section>

                    <!-- ã€ä¿®æ­£å•é¡ŒäºŒã€‘åœ–è¡¨å€åŸŸ - å¢å¼·æ™‚é–“æ§åˆ¶å’Œç¸½è¨ˆé¡¯ç¤º -->
                    <section class="dashboard-section-card">
                        <h2 class="dashboard-section-title">äººåŠ›èˆ‡é›¶ç”¨é‡‘è¶¨å‹¢</h2>
                        
                        <!-- åœ–è¡¨é ç±¤ -->
                        <div class="chart-tabs-container">
                            <button id="tabLaborChart" class="chart-tab-button active">çµ„å·¥äººæ•¸è®ŠåŒ–</button>
                            <button id="tabPettyCashChart" class="chart-tab-button">é›¶ç”¨é‡‘æ”¯å‡º</button>
                        </div>
                        
                        <!-- æ™‚é–“æ§åˆ¶å€ -->
                        <div class="chart-controls-row">
                            <div class="time-scale-controls">
                                <button class="time-scale-btn active" data-scale="day">æ—¥</button>
                                <button class="time-scale-btn" data-scale="week">é€±</button>
                                <button class="time-scale-btn" data-scale="month">æœˆ</button>
                            </div>
                            <div class="time-navigation">
                                <button class="time-nav-btn" id="prevPeriod">â† å‰</button>
                                <span class="current-period-label" id="currentPeriodLabel">æœ¬é€±</span>
                                <button class="time-nav-btn" id="nextPeriod">å¾Œ â†’</button>
                            </div>
                        </div>
                        
                        <!-- ç¸½è¨ˆé¡¯ç¤º -->
                        <div class="chart-summary-box">
                            <span class="summary-label" id="summaryLabel">æœ¬é€±ç¸½è¨ˆ</span>
                            <span class="summary-value" id="chartSummaryValue">85äºº</span>
                        </div>
                        
                        <!-- äººåŠ›åœ–è¡¨ -->
                        <div id="contentLaborChart">
                            <div class="chart-visual-area">
                                <svg width="100%" height="100%" viewBox="0 0 360 200" preserveAspectRatio="xMidYMid meet" id="laborChartSvg">
                                    <!-- Yè»¸ -->
                                    <line x1="50" y1="20" x2="50" y2="160" stroke="#ccc" stroke-width="1"/>
                                    <!-- Xè»¸ -->
                                    <line x1="50" y1="160" x2="340" y2="160" stroke="#ccc" stroke-width="1"/>
                                    
                                    <!-- Yè»¸æ¨™ç±¤ -->
                                    <text x="45" y="25" text-anchor="end" font-size="11" fill="#666">20äºº</text>
                                    <text x="45" y="60" text-anchor="end" font-size="11" fill="#666">15äºº</text>
                                    <text x="45" y="95" text-anchor="end" font-size="11" fill="#666">10äºº</text>
                                    <text x="45" y="130" text-anchor="end" font-size="11" fill="#666">5äºº</text>
                                    <text x="45" y="165" text-anchor="end" font-size="11" fill="#666">0äºº</text>
                                    
                                    <!-- ç¶²æ ¼ç·š -->
                                    <line x1="50" y1="25" x2="340" y2="25" stroke="#f0f0f0" stroke-width="0.5"/>
                                    <line x1="50" y1="60" x2="340" y2="60" stroke="#f0f0f0" stroke-width="0.5"/>
                                    <line x1="50" y1="95" x2="340" y2="95" stroke="#f0f0f0" stroke-width="0.5"/>
                                    <line x1="50" y1="130" x2="340" y2="130" stroke="#f0f0f0" stroke-width="0.5"/>
                                    
                                    <g class="x-axis-labels-group"></g>
                                    <polyline class="data-line" fill="none" stroke="#007bff" stroke-width="2.5" stroke-linecap="round"/>
                                    <g class="data-points-group"></g>
                                </svg>
                                <div id="laborTooltip" class="data-tooltip"></div>
                            </div>
                        </div>
                        
                        <!-- é›¶ç”¨é‡‘åœ–è¡¨ -->
                        <div id="contentPettyCashChart" style="display: none;">
                            <div class="chart-visual-area">
                                <svg width="100%" height="100%" viewBox="0 0 360 200" preserveAspectRatio="xMidYMid meet" id="pettyCashChartSvg">
                                    <!-- Yè»¸ -->
                                    <line x1="50" y1="20" x2="50" y2="160" stroke="#ccc" stroke-width="1"/>
                                    <!-- Xè»¸ -->
                                    <line x1="50" y1="160" x2="340" y2="160" stroke="#ccc" stroke-width="1"/>
                                    
                                    <!-- Yè»¸æ¨™ç±¤ -->
                                    <text x="45" y="25" text-anchor="end" font-size="11" fill="#666">8è¬</text>
                                    <text x="45" y="60" text-anchor="end" font-size="11" fill="#666">6è¬</text>
                                    <text x="45" y="95" text-anchor="end" font-size="11" fill="#666">4è¬</text>
                                    <text x="45" y="130" text-anchor="end" font-size="11" fill="#666">2è¬</text>
                                    <text x="45" y="165" text-anchor="end" font-size="11" fill="#666">0å…ƒ</text>
                                    
                                    <!-- ç¶²æ ¼ç·š -->
                                    <line x1="50" y1="25" x2="340" y2="25" stroke="#f0f0f0" stroke-width="0.5"/>
                                    <line x1="50" y1="60" x2="340" y2="60" stroke="#f0f0f0" stroke-width="0.5"/>
                                    <line x1="50" y1="95" x2="340" y2="95" stroke="#f0f0f0" stroke-width="0.5"/>
                                    <line x1="50" y1="130" x2="340" y2="130" stroke="#f0f0f0" stroke-width="0.5"/>
                                    
                                    <g class="x-axis-labels-group"></g>
                                    <polyline class="data-line" fill="none" stroke="#fd7e14" stroke-width="2.5" stroke-linecap="round"/>
                                    <g class="data-points-group"></g>
                                </svg>
                                <div id="pettyCashTooltip" class="data-tooltip"></div>
                            </div>
                        </div>
                    </section>

                    <!-- é€²åº¦ç‹€æ…‹ -->
                    <section class="dashboard-section-card">
                        <h2 class="dashboard-section-title">é€²åº¦ç‹€æ…‹</h2>
                        <div class="status-alert">
                            <i class="fas fa-hourglass-half"></i>
                            <div class="status-alert-content">
                                <h3>é€²åº¦ï¼šè¼•å¾®å»¶é²</h3>
                                <p>è¼ƒé æœŸæ™š 3 å¤©ï¼Œéœ€è¿½è¹¤</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- ã€ä¿®æ­£å•é¡Œå››ã€‘ç”˜ç‰¹åœ– -->
                    <section class="gantt-container-card">
                        <div class="gantt-header">
                           <h2 class="gantt-title">å·¥ç¨‹é€²åº¦è¡¨</h2>
                           <div class="gantt-view-controls">
                               <button class="gantt-view-btn active">æœˆ</button>
                               <button class="gantt-view-btn">é€±</button>
                               <button class="gantt-view-btn">æ—¥</button>
                           </div>
                        </div>
                        <div class="gantt-chart-area">
                            <div class="gantt-timeline" id="ganttTimeline">
                                <!-- æ—¥æœŸæ¨™é ­å°‡ç”± JavaScript (gantt.js) ç”Ÿæˆ -->
                            </div>
                            <div style="position: relative; min-height: 100px;" id="ganttTasksBoss">
                                <!-- ä»»å‹™æ¢å°‡ç”± JavaScript (gantt.js) ç”Ÿæˆ -->
                                <!-- ä»Šæ—¥ç·šä¹Ÿå°‡ç”± gantt.js æ§åˆ¶ -->
                            </div>
                        </div>
                    </section>

                    <!-- å“è³ªæ¦‚æ³ -->
                    <section class="dashboard-section-card">
                        <h2 class="dashboard-section-title">å“è³ªæ¦‚æ³</h2>
                        <div class="quality-grid">
                            <div class="quality-metric">
                                <div class="number" style="color: var(--accent-red);">5</div>
                                <div class="label">å¾…æ”¹å–„ç¼ºå¤±</div>
                            </div>
                            <div class="quality-metric">
                                <div class="number" style="color: var(--accent-green);">92%</div>
                                <div class="label">æœ¬æœˆæŸ¥é©—åˆæ ¼ç‡</div>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
        
        <!-- ã€ä¿®æ­£å•é¡Œä¸‰ã€‘å´é‚Šæ¬„ -->
        <div id="unpaidSidebar" class="sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">è«‹æ¬¾é€²åº¦è¡¨</h3>
                <button id="closeSidebarBtn" class="sidebar-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-item-card">
                    <div class="sidebar-item-name">æœŸåˆ¥1: åŸºç¤å·¥ç¨‹</div>
                    <div class="sidebar-item-detail">é‡‘é¡: 1,200,000 å…ƒ</div>
                    <div class="sidebar-item-status status-paid">ç‹€æ…‹: å·²ä»˜æ¬¾</div>
                </div>
                <div class="sidebar-item-card">
                    <div class="sidebar-item-name">æœŸåˆ¥2: çµæ§‹é«”</div>
                    <div class="sidebar-item-detail">é‡‘é¡: 850,000 å…ƒ</div>
                    <div class="sidebar-item-status status-pending">ç‹€æ…‹: å¾…è«‹æ¬¾</div>
                </div>
                <div class="sidebar-item-card">
                    <div class="sidebar-item-name">æœŸåˆ¥3: è£ä¿®å·¥ç¨‹</div>
                    <div class="sidebar-item-detail">é‡‘é¡: 2,100,000 å…ƒ</div>
                    <div class="sidebar-item-status status-pending">ç‹€æ…‹: å¾…è«‹æ¬¾</div>
                </div>
                <div class="sidebar-item-card">
                    <div class="sidebar-item-name">æœŸåˆ¥4: æ”¶å°¾å·¥ç¨‹</div>
                    <div class="sidebar-item-detail">é‡‘é¡: 450,000 å…ƒ</div>
                    <div class="sidebar-item-status status-pending">ç‹€æ…‹: å¾…è«‹æ¬¾</div>
                </div>
            </div>
        </div>
        
        <!-- å´é‚Šæ¬„é®ç½© -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
    </div>

    <!-- API è…³æœ¬ -->
    <script src="../assets/js/api.js"></script>
    
   <!-- å´é‚Šæ¬„çµ„ä»¶ -->
    <script src="../assets/js/components/sidebar.js"></script>

    <script src="../assets/js/utils/navigation.js" onerror="console.error('Failed to load navigation.js')"></script>
    <script src="../assets/js/utils/form-handler.js" onerror="console.error('Failed to load form-handler.js')"></script>
    <!-- å¼•å…¥æ¨¡çµ„åŒ–çš„åœ–è¡¨è…³æœ¬ -->
    <script type="module" src="../assets/js/utils/chart-utils.js" onerror="console.error('Failed to load chart-utils.js')"></script>
    <!-- dashboard.js æœƒå°å…¥ gantt.jsï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦å–®ç¨å¼•å…¥ gantt.js -->
    <script type="module" src="../assets/js/pages/dashboard.js" onerror="console.error('Failed to load dashboard.js')"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = performance.now();
            console.log('ğŸš€ Boss Dashboard é–‹å§‹åˆå§‹åŒ–');

            // åˆå§‹åŒ– LIFF
            if (typeof initializeLIFF === 'function') {
                initializeLIFF();
            }
            
            // æª¢æŸ¥å¿…è¦ä¾è³´ - æ·»åŠ å»¶é²ç­‰å¾…è…³æœ¬è¼‰å…¥
            setTimeout(() => {
                const requiredGlobals = ['FormHandler', 'initializeNavigation', 'setInitialPage'];
                const missingDependencies = requiredGlobals.filter(dep => typeof window[dep] === 'undefined');
                
                if (missingDependencies.length > 0) {
                    console.warn('Missing dependencies after timeout:', missingDependencies);
                }
            }, 500);
            
            // DOM å…ƒç´ æª¢æŸ¥
            const requiredElements = ['siteListContainer', 'filterCriteria', 'sortOrder'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));
            
            if (missingElements.length > 0) {
                console.error('Missing required DOM elements:', missingElements);
                // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è³‡è¨Š
                missingElements.forEach(elementId => {
                    console.error(`Element with ID '${elementId}' not found in DOM`);
                });
                return;
            }
            
            // DOM å…ƒç´  (éå°èˆªç›¸é—œ, éåœ–è¡¨ç›¸é—œ, éç”˜ç‰¹åœ–ç›¸é—œ)
            const siteListContainer = document.getElementById('siteListContainer');
            const filterCriteriaSelect = document.getElementById('filterCriteria');
            const sortOrderSelect = document.getElementById('sortOrder');
            
            // å´é‚Šæ¬„ç›¸é—œçš„ DOM å…ƒç´ ç²å–ã€å‡½æ•¸å®šç¾©å’Œäº‹ä»¶ç›£è½å™¨å·²ç§»è‡³ dashboard.js åŠ sidebar.js
            
            // ç”˜ç‰¹åœ–æ™‚é–“è»¸ç”Ÿæˆé‚è¼¯å·²ç§»è‡³ dashboard.js ä¸¦ç”± GanttChart é¡è™•ç†

            const mockSitesData = [
                { id: 'alpha', name: 'å·¥åœ° Alpha (å¤©é¾åœ‹è±ªå®…)', progress_delay: 15, cost_overrun_risk: 3, expiry_days: 95, defects: 8 },
                { id: 'beta', name: 'å·¥åœ° Beta (æµ·æ™¯æ¸¡å‡æ‘)', progress_delay: 5, cost_overrun_risk: 1, expiry_days: 180, defects: 3 },
                { id: 'gamma', name: 'å·¥åœ° Gamma (æ–‡å‰µåœ’å€æ”¹é€ )', progress_delay: -7, cost_overrun_risk: 0, expiry_days: 210, defects: 1 },
                { id: 'delta', name: 'å·¥åœ° Delta (åé„‰æ ¡èˆé‡å»º)', progress_delay: 0, cost_overrun_risk: 2, expiry_days: 30, defects: 2 }
            ];

                function renderSiteCards() {
                if (!siteListContainer || !filterCriteriaSelect || !sortOrderSelect) return;
                siteListContainer.innerHTML = '';
                
                const filterControlsElement = document.querySelector('.filter-controls');
                if (!filterControlsElement) {
                    console.warn('Filter controls element not found for renderSiteCards.');
                    return;
                }
                
                // æ”¹å–„ FormHandler æª¢æŸ¥
                let filterData;
                if (window.FormHandler && typeof window.FormHandler.getFormData === 'function') {
                    filterData = window.FormHandler.getFormData(filterControlsElement);
                } else {
                    // Fallback: ç›´æ¥ç²å–è¡¨å–®å€¼
                    console.warn('FormHandler not available, using fallback method');
                    filterData = {
                        filterCriteria: filterCriteriaSelect.value || 'progress_delay',
                        sortOrder: sortOrderSelect.value || 'desc'
                    };
                }

                // æ·»åŠ ç¼ºå°‘çš„è®Šæ•¸å®£å‘Š
                const currentFilter = filterData.filterCriteria;
                const currentSortOrder = filterData.sortOrder;
                let sitesToRender = [...mockSitesData]; // è¤‡è£½é™£åˆ—é¿å…ä¿®æ”¹åŸå§‹è³‡æ–™

                sitesToRender.sort((a, b) => {
                    let valA, valB;
                    if (currentFilter === 'progress_delay') { valA = a.progress_delay; valB = b.progress_delay; } 
                    else if (currentFilter === 'cost_overrun') { valA = a.cost_overrun_risk; valB = b.cost_overrun_risk; } 
                    else if (currentFilter === 'expiry_near') { valA = a.expiry_days; valB = b.expiry_days; }
                    else { valA = a.progress_delay; valB = b.progress_delay; } // Default sort
                    if (currentFilter === 'expiry_near') return currentSortOrder === 'desc' ? valA - valB : valB - valA;
                    return currentSortOrder === 'desc' ? valB - valA : valA - valB;
                });

                sitesToRender.forEach(site => {
                    let metricHtml = '';
                    let statusClass = 'status-neutral';
                    switch (currentFilter) {
                        case 'progress_delay':
                            if (site.progress_delay > 5) statusClass = 'status-problem';
                            else if (site.progress_delay > 0) statusClass = 'status-warning';
                            else statusClass = 'status-good';
                            metricHtml = site.progress_delay > 0 ? `<span class="label">é€²åº¦è½å¾Œï¼š</span><span class="value">${site.progress_delay} å¤©</span>` : (site.progress_delay < 0 ? `<span class="label">é€²åº¦è¶…å‰ï¼š</span><span class="value good">${Math.abs(site.progress_delay)} å¤©</span>` : `<span class="label">é€²åº¦ï¼š</span><span class="value good">æ­£å¸¸</span>`);
                            break;
                        case 'cost_overrun':
                            let riskText = "ä½"; let riskClass = 'value good';
                            if (site.cost_overrun_risk === 1) { riskText = "ä¸­"; riskClass = 'value text-orange-500'; statusClass = 'status-warning'; }
                            else if (site.cost_overrun_risk >= 2) { riskText = "é«˜"; riskClass = 'value text-red-500'; statusClass = 'status-problem'; }
                            else { statusClass = 'status-good'; }
                            metricHtml = `<span class="label">æˆæœ¬é¢¨éšªï¼š</span><span class="${riskClass}">${riskText}</span>`;
                            break;
                        case 'expiry_near':
                            let expiryClass = 'value good';
                            if (site.expiry_days < 90) expiryClass = 'value text-orange-500';
                            if (site.expiry_days < 30) expiryClass = 'value text-red-500';
                            if (site.expiry_days < 30) statusClass = 'status-problem';
                            else if (site.expiry_days < 90) statusClass = 'status-warning';
                            else statusClass = 'status-good';
                            metricHtml = `<span class="label">åˆç´„å‰©é¤˜ï¼š</span><span class="${expiryClass}">${site.expiry_days} å¤©</span>`;
                            break;
                    }
                    const card = `
                        <div class="site-card ${statusClass}">
                            <h3 class="site-name">${site.name}</h3>
                            <p class="metric-display">${metricHtml}</p>
                            <div class="other-info">
                                <span><i class="fas fa-${site.defects > 5 ? 'exclamation-circle text-red-500' : (site.defects > 2 ? 'exclamation-triangle text-orange-500' : (site.defects > 0 ? 'info-circle text-sky-500' : 'check-circle text-green-500'))}"></i> å¾…æ”¹å–„ç¼ºå¤±: ${site.defects} é …</span>
                                <span><i class="far fa-calendar-alt"></i> ${currentFilter !== 'expiry_near' ? `åˆç´„å‰©é¤˜: ${site.expiry_days} å¤©` : (currentFilter !== 'progress_delay' && site.progress_delay !==0 ? (site.progress_delay < 0 ? `é€²åº¦è¶…å‰: ${Math.abs(site.progress_delay)} å¤©` : `é€²åº¦è½å¾Œ: ${site.progress_delay} å¤©`) : 'é€²åº¦æ­£å¸¸')}</span>
                            </div>
                            <a href="#" class="view-dashboard-btn" data-siteid="${site.id}" data-sitename="${site.name}">æŸ¥çœ‹å„€è¡¨æ¿ ></a>
                        </div>`;
                    siteListContainer.innerHTML += card;
                });
                // Re-attach listeners for newly created buttons after cards are rendered
                initializeBossDashboardNavigation(); 
            }
            
            // Event Listeners (Non-Navigation, Non-Chart, Non-Gantt)
            if (filterCriteriaSelect) filterCriteriaSelect.addEventListener('change', renderSiteCards);
            if (sortOrderSelect) sortOrderSelect.addEventListener('change', renderSiteCards);
            // å´é‚Šæ¬„äº‹ä»¶ç›£è½å™¨å·²ç§»è‡³ dashboard.js ä¸­ Sidebar å¯¦ä¾‹çš„åˆå§‹åŒ–éç¨‹
            
            // Initialize Navigation
            // ç¢ºä¿ navigation.js ä¸­çš„ initializeNavigation å’Œ setInitialPage æ˜¯å…¨å±€å¯ç”¨çš„æˆ–æ­£ç¢ºå°å…¥çš„
            function initializeBossDashboardNavigation() {
                const navConfigs = [
                    {
                        triggerSelector: '.view-dashboard-btn',
                        targetPageId: 'pageSiteDashboard',
                        options: {
                            titleUpdates: [{
                                elementId: 'dashboardTitle',
                                content: (triggerEl, context) => `${context.siteNameForTitle || 'å·¥åœ°'} - å„€è¡¨æ¿`
                            }],
                            recordScrollOnLeaveFrom: ['pageSiteList'] // ç•¶é›¢é–‹ pageSiteList å‰å¾€ pageSiteDashboard æ™‚è¨˜éŒ„æ»¾å‹•
                        },
                        passDatasetToOptions: [{ datasetKey: 'sitename', optionKey: 'siteNameForTitle' }]
                    },
                    {
                        triggerSelector: '#pageSiteDashboard .back-button',
                        targetPageId: 'pageSiteList',
                        options: {
                            preserveScrollOnReturnTo: ['pageSiteList'] // ç•¶å›åˆ° pageSiteList æ™‚æ¢å¾©æ»¾å‹•
                            // recordScrollOnLeaveFrom å¯ä»¥åœ¨å°èˆªåˆ°è©³ç´°é æ™‚çµ±ä¸€è™•ç†ï¼Œ
                            // æˆ–è€…å¦‚æœç‰¹å®šè¿”å›æŒ‰éˆ•æœ‰ç‰¹æ®Šé‚è¼¯ï¼Œä¹Ÿå¯ä»¥åœ¨é€™è£¡åŠ ã€‚
                            // ç‚ºäº†ç°¡æ½”ï¼Œä¸»è¦åœ¨é›¢é–‹åˆ—è¡¨é æ™‚è¨˜éŒ„ã€‚
                        }
                    }
                ];
                const currentActivePageId = window._navigationContext?.currentPageId || 'pageSiteList';
                try {
                    window.initializeNavigation(navConfigs, { currentPageId: currentActivePageId });
                } catch (error) {
                    console.error('Failed to initialize navigation:', error);
                }
            }

            // Initial Setup
            const initialPageId = document.querySelector('.page.active')?.id || 'pageSiteList';
            
            if (typeof window.setInitialPage === 'function') {
                try {
                    window.setInitialPage(initialPageId);
                    console.log(`Initial page set to: ${initialPageId}`);
                } catch (error) {
                    console.error('Failed to set initial page:', error);
                }
            } else {
                console.warn('setInitialPage function not available - using default active page');
            }
            
            // generateGanttTimeline(); // å·²è¢«ç§»é™¤ï¼Œç”± dashboard.js ä¸­çš„ GanttChart è™•ç†
            
            // åœ–è¡¨ç›¸é—œçš„åˆå§‹åŒ–å·²ç§»è‡³ dashboard.js

            // æ€§èƒ½ç›£æ§ - åˆå§‹åŒ–å®Œæˆ
            const endTime = performance.now();
            const initTime = (endTime - startTime).toFixed(2);
            console.log(`âœ… Boss Dashboard åˆå§‹åŒ–å®Œæˆï¼Œè€—æ™‚: ${initTime}ms`);

        });
    </script>
</body>
</html>