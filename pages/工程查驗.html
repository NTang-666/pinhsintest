<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>品信工務系統 - 工地查驗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/pages/inspection.css">
</head>
<body>
    <div class="mobile-container">
        <div class="overlay" id="overlay"></div>

        <div id="pageSelectSiteForInspection" class="page active">
            <header>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.37 3.414-1.414 3.414H4.828c-1.784 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                <h1 class="text-xl font-bold">選擇查驗工地</h1>
            </header>
            <main class="content-area">
                <div class="card inspection-site-card" data-site-id="siteA" data-site-name="工地A：市中心建案">
                    <h2 class="text-lg font-bold text-main mb-1">工地A：市中心建案</h2>
                    <p class="text-xs text-secondary flex items-center">
                        <i class="fas fa-exclamation-triangle fa-fw mr-1.5 text-orange-500"></i>3項缺失待改善
                    </p>
                    <p class="text-xs text-secondary">上次查驗: 2025-05-28</p>
                </div>
                <div class="card inspection-site-card" data-site-id="siteB" data-site-name="工地B：山區別墅區">
                    <h2 class="text-lg font-bold text-main mb-1">工地B：山區別墅區</h2>
                    <p class="text-xs text-secondary flex items-center">
                        <i class="fas fa-check-circle fa-fw mr-1.5 text-green-500"></i>查驗正常
                    </p>
                    <p class="text-xs text-secondary">上次查驗: 2025-05-30</p>
                </div>
            </main>
        </div>

        <div id="pageSelectInspectionMode" class="page">
            <header class="page-header">
                <div class="back-button-area">
                    <button class="btn-icon back-button" data-target-page="pageSelectSiteForInspection">
                        <i class="fas fa-arrow-left text-accent"></i>
                    </button>
                </div>
                <div class="title-area">
                    <h1 id="selectModeTitle" class="text-xl font-bold text-main">查驗作業</h1>
                </div>
                <div class="actions-area"></div> </header>
            <main class="content-area grid grid-cols-1 gap-4">
                <div class="card mode-selection-card" id="btnQuickDefectReport">
                    <i class="fas fa-bolt"></i>
                    <h2>快速缺失回報</h2>
                    <p class="text-xs">快速記錄現場單點缺失</p>
                </div>
                <div class="card mode-selection-card" id="btnSystemInspection">
                    <i class="fas fa-clipboard-check"></i>
                    <h2>系統工程查驗</h2>
                    <p class="text-xs">依標準範本進行詳細查驗</p>
                </div>
            </main>
        </div>

        <div id="pageQuickDefectReport" class="page">
            <header class="page-header">
                 <div class="back-button-area">
                    <button class="btn-icon back-button" data-target-page="pageSelectInspectionMode" data-is-form="true">
                        <i class="fas fa-arrow-left text-accent"></i>
                    </button>
                </div>
                <div class="title-area">
                    <h1 id="quickDefectTitle" class="text-xl font-bold text-main">回報缺失</h1>
                </div>
                <div class="actions-area"></div>
            </header>
            <main class="content-area space-y-4">
                <div class="form-group">
                    <label for="defectFloor" class="form-label">查驗樓層*</label>
                    <input type="text" id="defectFloor" name="defectFloor" class="form-input" placeholder="例如: 3F, B2">
                </div>
                <div class="form-group">
                    <label for="defectLocation" class="form-label">查驗位置*</label>
                    <input type="text" id="defectLocation" name="defectLocation" class="form-input" placeholder="例如: A棟東側客廳">
                </div>
                <div class="form-group">
                    <label for="defectCategory" class="form-label">缺失類別*</label>
                    <select id="defectCategory" name="defectCategory" class="form-select">
                        <option value="水電">水電</option>
                        <option value="泥作">泥作</option>
                        <option value="模板">模板</option>
                        <option value="設備">設備</option>
                        <option value="安全">安全</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="defectDescription" class="form-label">缺失描述*</label>
                    <textarea id="defectDescription" name="defectDescription" rows="4" class="form-textarea" placeholder="請詳細描述缺失情況..."></textarea>
                </div>
                <div class="form-group form-photo-upload">
                    <label class="form-label">上傳照片*</label>
                    <button class="btn btn-secondary w-full"><i class="fas fa-camera mr-2"></i>選擇照片</button>
                    <div class="photo-preview-grid" id="quickDefectPhotoPreview">
                        </div>
                </div>
            </main>
            <footer class="action-footer">
                <button id="submitQuickDefectBtn" class="btn btn-primary">確認送出</button>
            </footer>
        </div>

        <div id="pageSelectInspectionTemplate" class="page">
            <header class="page-header">
                <div class="back-button-area">
                    <button class="btn-icon back-button" data-target-page="pageSelectInspectionMode">
                        <i class="fas fa-arrow-left text-accent"></i>
                    </button>
                </div>
                <div class="title-area">
                    <h1 id="selectTemplateTitle" class="text-xl font-bold text-main">選擇查驗範本</h1>
                </div>
                <div class="actions-area"></div>
            </header>
            <main class="content-area">
                <div class="mb-4">
                    <input type="text" placeholder="🔍 搜尋範本名稱..." class="form-input text-sm">
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 mb-2 mt-3">結構工程</h3>
                    <div class="card inspection-template-card" data-template-id="template1" data-template-name="結構體鋼筋查驗">
                        <p class="text-main font-medium"><i class="fas fa-clipboard-list fa-fw mr-2 text-gray-400"></i>結構體鋼筋查驗</p>
                    </div>
                    <div class="card inspection-template-card" data-template-id="template2" data-template-name="模板組立查驗">
                        <p class="text-main font-medium"><i class="fas fa-ruler-combined fa-fw mr-2 text-gray-400"></i>模板組立查驗</p>
                    </div>

                    <h3 class="text-sm font-semibold text-gray-500 mb-2 mt-4">防水工程</h3>
                     <div class="card inspection-template-card" data-template-id="template3" data-template-name="屋頂防水層查驗">
                        <p class="text-main font-medium"><i class="fas fa-tint fa-fw mr-2 text-gray-400"></i>屋頂防水層查驗</p>
                    </div>
                </div>
            </main>
        </div>

        <div id="pageDynamicInspectionInput" class="page">
             <header class="page-header">
                <div class="back-button-area">
                    <button class="btn-icon back-button" data-target-page="pageSelectInspectionTemplate" data-is-form="true">
                        <i class="fas fa-arrow-left text-accent"></i>
                    </button>
                </div>
                <div class="title-area">
                     <h1 id="dynamicInspectionTitle" class="text-lg font-bold text-main">查驗表填寫</h1>
                </div>
                <div class="actions-area"></div>
            </header>
            <main class="content-area space-y-4">
                <div class="card">
                    <h2 class="text-base font-semibold text-main mb-3" id="inspectionFormHeader">範本名稱 - 工地名</h2>
                    <div class="grid grid-cols-2 gap-4 mb-3 text-sm">
                        <div><label class="form-label">查驗樓層</label><input type="text" name="inspectionFloor" class="form-input" placeholder="例: 3F"></div>
                        <div><label class="form-label">查驗位置</label><input type="text" name="inspectionLocation" class="form-input" placeholder="例: 主樑"></div>
                        <div><label class="form-label">查驗日期</label><input type="date" name="inspectionDate" class="form-input"></div>
                        <div><label class="form-label">參照圖說</label><input type="text" name="inspectionDrawingRef" class="form-input" placeholder="選填"></div>
                    </div>
                </div>

                <div id="inspectionItemsArea" class="space-y-3">
                    <!-- Dynamic inspection items will be generated by JS -->
                    <!-- Example structure for one item (to be used as template):
                    <div class="card inspection-item-card">
                        <p class="text-xs text-gray-500 mb-1 item-label">項目 X</p>
                        <p class="text-sm font-medium text-main mb-1 item-description">查驗項目描述 (設計標準)</p>
                        <div class="form-group"><label class="form-label text-xs">實測值</label><input type="text" name="itemMeasuredValue" data-key="measuredValue" class="form-input form-input-sm"></div>
                        <div class="form-group"><label class="form-label text-xs">結果</label>
                            <select name="itemResult" data-key="result" class="form-select form-select-sm"><option value="合格">合格</option><option value="不合格">不合格</option><option value="N/A">N/A</option></select>
                        </div>
                        <div class="form-group"><label class="form-label text-xs">照片</label><button class="btn btn-secondary btn-sm w-full item-photo-upload"><i class="fas fa-camera mr-1"></i>上傳</button></div>
                        <div class="form-group"><label class="form-label text-xs">備註</label><input type="text" name="itemNotes" data-key="notes" class="form-input form-input-sm"></div>
                         <input type="hidden" name="itemOriginalDescription" data-key="originalDescription" value="查驗項目描述 (設計標準)">
                         <input type="hidden" name="itemIndex" data-key="itemIndex" value="X">
                    </div>
                    -->
                </div>
                 <div class="card">
                     <label for="overallInspectionNotes" class="form-label">總體備註/結論</label>
                     <textarea id="overallInspectionNotes" name="overallInspectionNotes" rows="3" class="form-textarea"></textarea>
                 </div>
            </main>
            <footer class="action-footer">
                <button id="saveInspectionBtn" class="btn btn-primary">儲存查驗結果</button>
            </footer>
        </div>

    </div>

    <script src="../assets/js/utils/navigation.js"></script>
    <script src="../assets/js/utils/form-handler.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 狀態變數 (部分移至 navigation.js 或作為 context 傳遞) ---
            let inspectionContext = {
                selectedSite: { id: null, name: null },
                selectedTemplate: { id: null, name: null },
                // unsavedChanges flag will be managed by navigation.js's manageUnsavedChanges
            };

            const UNSAVED_CONTEXT_QUICK_DEFECT = 'quickDefectForm';
            const UNSAVED_CONTEXT_DYNAMIC_INSPECTION = 'dynamicInspectionForm';

            // --- DOM 元素 (非導航相關，或由 navigation.js 間接控制) ---
            // ... (保留其他非導航的 DOM 元素獲取，如果有的話)

            // --- 非導航相關邏輯 ---
            function clearQuickDefectForm() {
                const formElement = document.getElementById('pageQuickDefectReport');
                if (formElement) {
                    FormHandler.clearForm(formElement);
                    // Reset select to default if FormHandler.clearForm doesn't handle it as desired
                    const defectCategorySelect = formElement.querySelector('#defectCategory');
                    if (defectCategorySelect) defectCategorySelect.value = '水電';
                }
                const photoPreview = document.getElementById('quickDefectPhotoPreview');
                if (photoPreview) photoPreview.innerHTML = ''; // Photo preview is not a standard form field
                manageUnsavedChanges(UNSAVED_CONTEXT_QUICK_DEFECT, false);
            }
            
            function clearDynamicInspectionForm() {
                const formElement = document.getElementById('pageDynamicInspectionInput');
                if (formElement) {
                    FormHandler.clearForm(formElement);
                     // Clear dynamic items area separately
                    const inspectionItemsArea = document.getElementById('inspectionItemsArea');
                    if (inspectionItemsArea) inspectionItemsArea.innerHTML = ''; // Or load default template items
                }
                const formHeader = document.getElementById('inspectionFormHeader');
                if (formHeader) formHeader.textContent = '範本名稱 - 工地名';
                manageUnsavedChanges(UNSAVED_CONTEXT_DYNAMIC_INSPECTION, false);
            }


            // 表單輸入時標記未儲存 - 使用事件委派替代直接綁定
            const quickDefectContainer = document.getElementById('pageQuickDefectReport');
            if (quickDefectContainer) {
                quickDefectContainer.addEventListener('input', (e) => {
                    if (e.target.matches('input, select, textarea')) {
                        manageUnsavedChanges(UNSAVED_CONTEXT_QUICK_DEFECT, true);
                    }
                });
            }
            
            const dynamicInspectionContainer = document.getElementById('pageDynamicInspectionInput');
            if (dynamicInspectionContainer) {
                dynamicInspectionContainer.addEventListener('input', (e) => {
                    if (e.target.matches('input, select, textarea')) {
                        manageUnsavedChanges(UNSAVED_CONTEXT_DYNAMIC_INSPECTION, true);
                    }
                });
            }


            // --- Quick Defect Form Submission ---
            const quickDefectForm = document.getElementById('pageQuickDefectReport');
            const submitQuickDefectBtn = document.getElementById('submitQuickDefectBtn');

            if (quickDefectForm && submitQuickDefectBtn) {
                const quickDefectValidationRules = {
                    defectFloor: { required: true, message: '查驗樓層為必填欄位。' },
                    defectLocation: { required: true, message: '查驗位置為必填欄位。' },
                    defectDescription: { required: true, message: '缺失描述為必填欄位。' },
                    // defectCategory is a select, usually doesn't need validation unless specific value is disallowed
                };

                async function quickDefectSubmitCallback(formData) {
                    // In a real app, this would be an API call
                    console.log('Quick Defect Submitted:', formData);
                    alert('缺失已記錄！(模擬)');
                    manageUnsavedChanges(UNSAVED_CONTEXT_QUICK_DEFECT, false);
                    // Navigation is handled by initializeNavigation config for this button
                }

                async function quickDefectBeforeSubmit() {
                    return new Promise(resolve => {
                        resolve(confirm('確定送出此缺失回報嗎？'));
                    });
                }
                
                FormHandler.handleFormSubmit(
                    quickDefectForm,
                    submitQuickDefectBtn,
                    quickDefectSubmitCallback,
                    quickDefectValidationRules,
                    quickDefectBeforeSubmit
                );
            }

            // --- Dynamic Inspection Form Submission ---
            const dynamicInspectionForm = document.getElementById('pageDynamicInspectionInput');
            const saveInspectionBtn = document.getElementById('saveInspectionBtn');

            if (dynamicInspectionForm && saveInspectionBtn) {
                const dynamicInspectionValidationRules = {
                    inspectionFloor: { required: true, message: '查驗樓層為必填欄位。' },
                    inspectionLocation: { required: true, message: '查驗位置為必填欄位。' },
                    inspectionDate: { required: true, message: '查驗日期為必填欄位。' }
                    // Dynamic items would need separate validation logic if complex
                };

                async function dynamicInspectionSubmitCallback(formData) {
                    // formData here will contain main form fields.
                    // Dynamic items would need to be serialized separately if FormHandler.getFormData doesn't handle them.
                    // For now, we assume dynamic items are handled outside or not part of this basic submission.
                    // const dynamicItemsData = FormHandler.serializeDynamicItems(document.getElementById('inspectionItemsArea'), '.inspection-item-card');
                    // const fullData = { ...formData, items: dynamicItemsData };
                    console.log('Dynamic Inspection Submitted:', formData /*, fullData */);
                    alert('查驗結果已儲存！(模擬)');
                    manageUnsavedChanges(UNSAVED_CONTEXT_DYNAMIC_INSPECTION, false);
                     // Navigation is handled by initializeNavigation config for this button
                }
                
                async function dynamicInspectionBeforeSubmit() {
                     return new Promise(resolve => {
                        resolve(confirm('確定儲存本次查驗結果嗎？'));
                    });
                }

                FormHandler.handleFormSubmit(
                    dynamicInspectionForm,
                    saveInspectionBtn,
                    dynamicInspectionSubmitCallback,
                    dynamicInspectionValidationRules,
                    dynamicInspectionBeforeSubmit
                );
            }

            // --- 導航設定 ---
            const navConfigs = [
                {
                    triggerSelector: '.inspection-site-card',
                    targetPageId: 'pageSelectInspectionMode',
                    options: {
                        currentContext: inspectionContext,
                        beforeNavigate: (targetPageId, triggerEl, context) => {
                            context.selectedSite.id = triggerEl.dataset.siteId;
                            context.selectedSite.name = triggerEl.dataset.siteName;
                        },
                        afterNavigate: (targetPageId, triggerEl, context) => {
                             document.getElementById('selectModeTitle').textContent = `${context.selectedSite.name || '未選擇工地'} - 查驗作業`;
                        },
                        recordScrollOnLeaveFrom: ['pageSelectSiteForInspection']
                    }
                },
                {
                    triggerSelector: '#btnQuickDefectReport',
                    targetPageId: 'pageQuickDefectReport',
                    options: {
                        currentContext: inspectionContext,
                        afterNavigate: (targetPageId, triggerEl, context) => {
                            document.getElementById('quickDefectTitle').textContent = `${context.selectedSite.name || '未選擇工地'} - 回報缺失`;
                            clearQuickDefectForm(); // Clear form after navigating
                        }
                    }
                },
                {
                    triggerSelector: '#btnSystemInspection',
                    targetPageId: 'pageSelectInspectionTemplate',
                    options: {
                        currentContext: inspectionContext,
                         afterNavigate: (targetPageId, triggerEl, context) => {
                            document.getElementById('selectTemplateTitle').textContent = `${context.selectedSite.name || '未選擇工地'} - 選擇查驗範本`;
                        }
                    }
                },
                {
                    triggerSelector: '.inspection-template-card',
                    targetPageId: 'pageDynamicInspectionInput',
                    options: {
                        currentContext: inspectionContext,
                        beforeNavigate: (targetPageId, triggerEl, context) => {
                            context.selectedTemplate.id = triggerEl.dataset.templateId;
                            context.selectedTemplate.name = triggerEl.dataset.templateName;
                        },
                        afterNavigate: (targetPageId, triggerEl, context) => {
                            document.getElementById('dynamicInspectionTitle').textContent = `${context.selectedTemplate.name || '未選擇範本'}`;
                            document.getElementById('inspectionFormHeader').textContent = `${context.selectedTemplate.name || '範本'} - ${context.selectedSite.name || '工地'}`;
                            clearDynamicInspectionForm(); // Clear form after navigating
                            // Potentially load template items here
                        },
                        recordScrollOnLeaveFrom: ['pageSelectInspectionTemplate']
                    }
                },
                // Back buttons
                {
                    triggerSelector: '#pageSelectInspectionMode .back-button',
                    targetPageId: 'pageSelectSiteForInspection',
                    options: {
                        currentContext: inspectionContext,
                        preserveScrollOnReturnTo: ['pageSelectSiteForInspection']
                    }
                },
                {
                    triggerSelector: '#pageQuickDefectReport .back-button',
                    targetPageId: 'pageSelectInspectionMode',
                    options: {
                        currentContext: inspectionContext,
                        checkUnsaved: true,
                        unsavedChangesContext: UNSAVED_CONTEXT_QUICK_DEFECT
                    }
                },
                {
                    triggerSelector: '#pageSelectInspectionTemplate .back-button',
                    targetPageId: 'pageSelectInspectionMode',
                    options: { currentContext: inspectionContext }
                },
                {
                    triggerSelector: '#pageDynamicInspectionInput .back-button',
                    targetPageId: 'pageSelectInspectionTemplate',
                    options: {
                        currentContext: inspectionContext,
                        checkUnsaved: true,
                        unsavedChangesContext: UNSAVED_CONTEXT_DYNAMIC_INSPECTION,
                        preserveScrollOnReturnTo: ['pageSelectInspectionTemplate']
                    }
                },
                 // Submit buttons that also navigate
                {
                    triggerSelector: '#submitQuickDefectBtn', // Assuming this button also implies navigation after successful submit
                    targetPageId: 'pageSelectInspectionMode', // Navigate here after "successful" submit
                    options: {
                        currentContext: inspectionContext,
                        // No checkUnsaved here as it's handled by the button's own click listener before navigation
                        beforeNavigate: (targetPageId, triggerEl, context) => {
                            // This is called IF the primary action (submit) was "successful"
                            // and the navigation is about to occur.
                            // We assume the primary click handler for submitQuickDefectBtn already confirmed.
                            // If not, the primary click handler should return false to prevent navigation.
                            // The FormHandler.handleFormSubmit now handles validation.
                            // The beforeNavigate in navigation.js for submit buttons should primarily check if the
                            // form submission logic (which now includes validation) was successful.
                            // Since FormHandler.handleFormSubmit doesn't directly return success/failure to the event listener chain
                            // in a way that initializeNavigation's beforeNavigate can easily consume,
                            // we rely on manageUnsavedChanges being set to false if submission was "successful".
                            // If manageUnsavedChanges is false, it implies data was "saved".
                            if (!manageUnsavedChanges(UNSAVED_CONTEXT_QUICK_DEFECT, undefined, true)) { // Check if still unsaved
                                return true; // Proceed if changes were marked as saved
                            }
                            // If still marked as unsaved, it means validation/confirmation failed in FormHandler
                            return false;
                        }
                    }
                },
                {
                    triggerSelector: '#saveInspectionBtn', // Assuming this button also implies navigation
                    targetPageId: 'pageSelectInspectionTemplate',
                    options: {
                        currentContext: inspectionContext,
                        beforeNavigate: (targetPageId, triggerEl, context) => {
                            // Similar logic for dynamic inspection form
                            if (!manageUnsavedChanges(UNSAVED_CONTEXT_DYNAMIC_INSPECTION, undefined, true)) {
                                return true;
                            }
                            return false;
                        }
                    }
                }
            ];

            const initialPageId = document.querySelector('.page.active')?.id || 'pageSelectSiteForInspection';
            setInitialPage(initialPageId);
            initializeNavigation(navConfigs, inspectionContext);

            // Global beforeunload for unsaved changes (covers browser refresh/close)
            window.addEventListener('beforeunload', function (e) {
                const currentPageId = _navigationContext.currentPageId; // Use the one from navigation.js
                let unsavedContextKey = null;
                if (currentPageId === 'pageQuickDefectReport') unsavedContextKey = UNSAVED_CONTEXT_QUICK_DEFECT;
                else if (currentPageId === 'pageDynamicInspectionInput') unsavedContextKey = UNSAVED_CONTEXT_DYNAMIC_INSPECTION;

                if (unsavedContextKey && manageUnsavedChanges(unsavedContextKey)) {
                    const confirmationMessage = '您有未儲存的資料，確定要離開嗎？';
                    (e || window.event).returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            });
        });
    </script>
</body>
</html>
